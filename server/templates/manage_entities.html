{% extends 'base-form.html' %}
{% import "bootstrap/wtf.html" as wtf %}
{% block title %}{{super()}} | {{title}}{% endblock %}

{% block scripts %}
{{super()}}
<script>
    button = document.getElementById("new-entry");
</script>
<script>
    let backdrop = document.querySelector('.backdrop');
    let spinner = document.querySelector('.spinner-border');
    let modalDeleteEntity = document.getElementById('delete-entity-dialog');


    function dismissModal() {
        if (!spinner.style.display) {
            modalDeleteEntity.style.display = 'none';
            backdrop.style.display = 'none';
        }
    }

    let modalDeleteEntityMessage = document.getElementById('delete-entity-message');
    backdrop.addEventListener('click', dismissModal);
    document.getElementById('reject-entity-deleted').addEventListener('click', dismissModal);
    let entityDeleteButton;
    // @formatter:off
    {% for entity in table %}
    // @formatter:on
    entityDeleteButton = document.getElementById('delete-entity-{{entity|last}}');

    entityDeleteButton.addEventListener('click', function () {
        let text = modalDeleteEntityMessage.getAttribute("data-text");
        text = text.replace('{name}', '{{entity|first}}');
        modalDeleteEntityMessage.innerHTML = text;

        modalDeleteEntity.style.display = 'block';
        backdrop.style.display = 'block';

        document.getElementById('confirm-entity-deleted').addEventListener('click', function () {
            spinner.style.display = 'inline-block';
            fetch("{{url_for('delete',entity_type=entity_type,id=entity|last)}}", {method: "POST"})
                .then(response => response.json())
                .then(output => {
                    let redirect_location = "{{url_for('manage',entity_type=entity_type)}}";
                    let message = output["message"];
                    let status = output["status"];
                    if (status === 200) {
                        window.location = redirect_location
                    } else {
                        alert(message)
                        window.location = redirect_location
                    }
                });
        });
    });
    // @formatter:off
    {% endfor %}
    // @formatter:on
</script>
{% endblock %}

{% block content %}
{{super()}}

<div class="backdrop"></div>
<div class="spinner-border text-warning" role="status"></div>
<div id="delete-entity-dialog" class="delete-modal">
    <h1 class="modal__title">Actually delete?</h1>
    <p id="delete-entity-message" data-text="Do you actually want to delete '{name}'?"
       class="lead delete-message"></p>
    <div class="row modal__actions">
        <button id="confirm-entity-deleted" class="btn btn-outline-warning col-lg-3 col-sm-6">Yes</button>
        <button id="reject-entity-deleted" class="btn btn-warning modal-dismiss col-lg-3 col-sm-6" type="button">No
        </button>
    </div>
</div>

<div class="container headline-container">
    <h1>{{title}}</h1>
</div>
<div class="container">
    {{ wtf.quick_form(form,novalidate=True) }}
</div>
<div class="container">
    <table class="bordered">
        <tr>
            <th>#</th>
            {% for headline in title_row %}
            <th>{{headline}}</th>
            {% endfor %}
            <th></th>
            <th></th>
        </tr>
        {% for entity in table %}
        <tr id="row-entity-{{ entity|last }}">
        <td class="center">{{loop.index}}</td>
            {% for value in entity %}
            {% if loop.index < entity|length %}
            <td>{% if value %}
                {% if value is boolean %}
                <input type="checkbox" disabled checked>
                {%else%}
                {{value}}
                {% endif %}
                {% endif %}
            </td>
            {% else %}
            <td>
                <a href="{{ url_for('manage',entity_type=entity_type,id=value) }}"
                   class="btn btn-outline-warning">
                    <i class="bi bi-pencil"></i>
                </a>
            </td>
            <td>
                <a href="#" id="delete-entity-{{ value }}" class="btn btn-outline-warning">
                    <i class="bi bi-trash"></i> </a>
            </td>
            {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}

    </table>
</div>

{% endblock %}